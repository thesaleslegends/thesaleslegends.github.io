import { supabase } from "../../services/supabase.js";

/* ===============================
   WEEK STATE
================================ */
let currentYear = 2026;
let currentWeek = 5;
let activeDay = null;

/* ===============================
   DOM
================================ */
const weekLabel = document.getElementById("weekLabel");
const prevWeekBtn = document.getElementById("prevWeek");
const nextWeekBtn = document.getElementById("nextWeek");

const modal = document.getElementById("planModal");
const employeeSelect = document.getElementById("employeeSelect");
const halfDayCheckbox = document.getElementById("halfDayCheckbox");
const saveShiftBtn = document.getElementById("saveShift");
const closeModalBtn = document.getElementById("cancelShift"); // ✅ klopt met HTML

/* ===============================
   INIT
================================ */
updateWeekLabel();
loadWeek();

/* ===============================
   WEEK NAVIGATIE
================================ */
prevWeekBtn.onclick = () => {
  currentWeek--;
  if (currentWeek < 1) {
    currentWeek = 52;
    currentYear--;
  }
  updateWeekLabel();
  loadWeek();
};

nextWeekBtn.onclick = () => {
  currentWeek++;
  if (currentWeek > 52) {
    currentWeek = 1;
    currentYear++;
  }
  updateWeekLabel();
  loadWeek();
};

function updateWeekLabel() {
  weekLabel.innerText = `Week ${currentWeek} (${currentYear})`;
}

/* ===============================
   MEDEWERKERS LADEN (SUPABASE)
================================ */
async function loadEmployees() {
  const { data, error } = await supabase
    .from("medewerkers")           // ✅ JUISTE TABEL
    .select("id, name")
    .eq("actief", true)
    .order("name");

  if (error) {
    console.error("Fout bij laden medewerkers:", error);
    return;
  }

  employeeSelect.innerHTML = `<option value="">Kies medewerker</option>`;

  data.forEach(emp => {
    const opt = document.createElement("option");
    opt.value = emp.id;
    opt.textContent = emp.name;
    employeeSelect.appendChild(opt);
  });
}

/* ===============================
   WEEK LADEN
================================ */
async function loadWeek() {
  document.querySelectorAll(".day-list").forEach(l => l.innerHTML = "");
  document.querySelectorAll(".summary-cell").forEach(c => c.innerText = "0");
  document.getElementById("weekTotal").innerText = "0";

  const { data: shifts, error } = await supabase
    .from("planning")
    .select(`
      id,
      day_of_week,
      half_day,
      medewerkers ( name )
    `)
    .eq("year", currentYear)
    .eq("week_number", currentWeek);

  if (error) {
    console.error("Fout bij laden planning:", error);
    return;
  }

  renderWeek(shifts);
  calculateTotals(shifts);
}

/* ===============================
   RENDEREN
================================ */
function renderWeek(shifts) {
  shifts.forEach(shift => {
    const list = document.querySelector(
      `.day-column[data-day="${shift.day_of_week}"] .day-list`
    );
    if (!list) return;

    const li = document.createElement("li");
    li.textContent =
      shift.medewerkers?.name + (shift.half_day ? " (½)" : "");

    list.appendChild(li);
  });
}

/* ===============================
   TOTALEN
================================ */
function calculateTotals(shifts) {
  const totals = {1:0,2:0,3:0,4:0,5:0,6:0,7:0};

  shifts.forEach(s => {
    totals[s.day_of_week] += s.half_day ? 0.5 : 1;
  });

  document.querySelectorAll(".summary-cell").forEach((c, i) => {
    c.innerText = totals[i + 1];
  });

  document.getElementById("weekTotal").innerText =
    Object.values(totals).reduce((a,b)=>a+b,0);
}

/* ===============================
   PLUSJE → MODAL
================================ */
document.querySelectorAll(".add-btn").forEach(btn => {
  btn.onclick = async () => {
    activeDay = btn.closest(".day-column").dataset.day;

    await loadEmployees(); // ✅ HIER MOET HIJ ZITTEN
    modal.style.display = "flex";
  };
});

/* ===============================
   MODAL SLUITEN
================================ */
closeModalBtn.onclick = () => {
  modal.style.display = "none";
  halfDayCheckbox.checked = false;
  employeeSelect.value = "";
  activeDay = null;
};

/* ===============================
   OPSLAAN SHIFT
================================ */
saveShiftBtn.onclick = async () => {
  if (!activeDay || !employeeSelect.value) return;

  const { error } = await supabase
    .from("planning")
    .insert({
      year: currentYear,
      week_number: currentWeek,
      day_of_week: Number(activeDay),
      employee_id: employeeSelect.value,
      half_day: halfDayCheckbox.checked
    });

  if (error) {
    alert("Fout bij opslaan");
    console.error(error);
    return;
  }

  modal.style.display = "none";
  halfDayCheckbox.checked = false;
  employeeSelect.value = "";
  loadWeek();
};

<script type="module" src="./planning.js"></script>git